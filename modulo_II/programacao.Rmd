# Programação com R

## Programação

- Por quê programar?

	-   Evitar repetições desnecessárias de análises ou cálculos que são
        repetidos com frequência.

    -   Fica documentado as etapas que você realizou para chegar a um
        resultado.

    -   Fácil recuperação e modificação de programas.

-   Como programar?

    -   Criando programas! (Scripts, rotinas, **algoritmos**).

    -   Crie uma sequência lógica de comandos que devem ser executados
        em ordem.

    -   Utilize as ferramentas básicas da programação: **estruturas de
        repetição** (`for()`) e **estruturas de seleção** (`if()`).

## Estrutura de repetição `for()`

-   Serve para repetir um ou mais comandos diversas vezes.

-   Exemplo: cálculo de notas de uma disciplina.

```{r }

## Importa os dados
notas <- read.table("../dados/notas.csv", header = TRUE,
                    sep=";", dec=",")
## Analisa a estrutura dos dados
str(notas)
head(notas)
summary(notas)

## Antes de seguir adiante, veja o resultado de
for(i in 1:30){
    print(notas[i, c("prova1", "prova2", "prova3")])
}

## Para calcular as médias das 3 provas, precisamos inicialmente de um
## vetor para armazenar os resultados. Esse vetor pode ser um novo
## objeto ou uma nova coluna no dataframe

## Aqui vamos criar uma nova coluna no dataframe, contendo apenas o
## valor 0
notas$media <- 0 # note que aqui será usada a regra da reciclagem, ou
                 # seja, o valor zero será repetido até completar todas
                 # as linhas do dataframe
# Estrutura de repetição para calcular a média
for(i in 1:30){
    ## Aqui, cada linha i da coluna media sera substituida pelo
    ## respectivo valor da media caculada
    notas$media[i] <- sum(notas[i, c("prova1", "prova2", "prova3")])/3
}

## Confere os resultados
head(notas)
```

Agora podemos melhorar o código, tornando-o mais **genérico**. Dessa
forma fica mais fácil fazer alterações e procurar erros. Uma forma de
melhorar o código acima é generalizando alguns passos.

```{r }
## Armazenamos o número de linhas no dataframe
nlinhas <- nrow(notas)
## Identificamos as colunas de interesse no cálculo da média, e
## armazenamos em um objeto separado
provas <- c("prova1", "prova2", "prova3")
## Sabendo o número de provas, fica mais fácil dividir pelo total no
## cálculo da média
nprovas <- length(provas)
## Cria uma nova coluna apenas para comparar o cálculo com o anterior
notas$media2 <- 0
## A estrutura de repetição fica
for(i in 1:nlinhas){
    notas$media2[i] <- sum(notas[i, provas])/nprovas
}

## Confere
head(notas)
```

Ainda podemos melhorar (leia-se: **otimizar**) o código, se utilizarmos
funções prontas do R. No caso da média isso é possível pois a função
`mean()` já existe. Em seguida veremos como fazer quando o cálculo que
estamos utilizando não está implementado em nenhuma função pronta do R.

```{r }
## Cria uma nova coluna apenas para comparação
notas$media3 <- 0
## A estrutura de repetição fica
for(i in 1:nlinhas){
    notas$media3[i] <- mean(as.numeric(notas[i, provas]))
}

## Confere
head(notas)

## A única diferença é que aqui precisamos transformar cada linha em um
## vetor de números com as.numeric(), pois
notas[1, provas]
## é um data.frame:
class(notas[1, provas])
```

Podemos agora inserir pesos para as provas: prova 1 = 4, prova 2 = 3,
prova 3 = 3.

```{r }
## Cria uma nova coluna para armazenar os resultados das médias
## ponderadas
notas$mediap <- 0
## Estrutura de repetição
for(i in 1:30){
    pesos <- notas[i, c("prova1", "prova2", "prova3")] * c(4,3,3)
    notas$mediap[i] <- sum(pesos)/10
}
## Confere os resultados
head(notas)
```

## Estrutura de seleção `if()`

-   Adicionando a condição do aluno de acordo com a nota.

```{r }
## Nova coluna para armazenar os resultados
notas$situacao <- NA
## Estrutura de repetição
for(i in 1:30){
    pesos <- notas[i, c("prova1", "prova2", "prova3")] *
        c(4,3,3)
    notas$mediap[i] <- sum(pesos)/10
    ## Estrutura de seleção
    if(notas$media[i] >= 7){
        notas$situacao[i] <- "aprovado"
    } else{
        notas$situacao[i] <- "reprovado"
    }
}
```

## O modo do R: vetorização

Através do processo de vetorização do R, o mesmo algoritmo pode ser
simplificado em duas etapas.

```{r }
## Criando uma funcao para calcular a media ponderada
mediap <- function(notas, pesos){
    saida <- numeric(nrow(notas))
    for(i in 1:nrow(notas)){
        aux <- notas[i,] * pesos
        saida[i] <- sum(aux)/10
    }
    return(saida)
}

## Confere o resultado
mediap(notas[,c("prova1", "prova2", "prova3")], c(4,3,3))

## Podemos conferir o nosso cálculo através da função mean() do R
apply(notas[, c("prova1", "prova2", "prova3")], 1, mean)
```
